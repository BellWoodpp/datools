# Session 2026-01-05T19:05:42+08:00

## 摘要

- 跑通 Creem 测试模式下的月付订阅结账，并澄清测试卡/测试环境、年付/月付 Product 映射、Webhook 与 Return URL 的区别。
- 为站内补齐“付款前可见”的续费/退款信息：新增 `/refund-policy`（含多语言路由）、页脚入口、定价卡跳转前的条款勾选确认。
- 调整 Professional 价格展示：英文与部分欧元语种月付从 `6` 改为 `9.99`（并同步年付以保持 20% 折扣展示逻辑）。
- 修复订阅查询报错：数据库缺少 `subscriptions` 表导致 `/api/traffic` 500；通过 Drizzle push 创建表。
- 曾临时加入“仅开发环境游客结账”用于测试后又移除，恢复为必须登录才能创建 checkout。

## 结论

- `invalid product_id mapping`：`CREEM_PRODUCTS` 未包含对应 `${planId}:${period}`（常见是默认选了 `yearly` 但只配置了 `monthly`）。
- `Expected double-quoted property name in JSON`：`CREEM_PRODUCTS` 的 JSON 字符串格式不合法（引号/逗号/注释等）。
- 线上 `403 Forbidden`：多见于 `CREEM_ENV`/API key 与 Product 所在环境不匹配（test key 打 production API 等），或账号/KYC 状态限制。
- Webhook 不能填 `localhost`；本地要用 ngrok/隧道暴露公网 HTTPS，才能看到 Creem 服务器投递到 `/api/pay/callback/creem`。
- Return/Success URL 不是 Webhook：回跳用于用户体验，Webhook 才是服务端可信状态源（订阅 active/cancelled/expired 等）。

## 下一步

- 在 Creem 后台配置 Webhook：URL 指向 `https://<public-host>/api/pay/callback/creem`，Secret 与 `CREEM_WEBHOOK_SECRET` 一致，并订阅订阅/结账事件。
- 为年付/月付分别创建 Product，并在 `CREEM_PRODUCTS` 中补齐 `professional:monthly` 与 `professional:yearly`（以及需要的话 `enterprise:*`）。
- 生产环境接入前处理 KYC/收款账户审核问题；确认 production key 与 production products 一致。
- 视需要完善支付成功落库与会员权益展示（订阅状态写入 `subscriptions` 表后在 membership/entitlements 中生效）。

## Transcript（精简）

**User**：支付测试需要测试卡、Webhook URL 能写 localhost 吗、是否必须 ngrok？  
**Assistant**：测试模式用 Stripe 测试卡；Webhook 必须公网 HTTPS，localhost 不可达；需要 ngrok/隧道才能在本地看到 Webhook 投递与事件处理。

**User**：付款前条款/退款政策放哪里，Creem 页面不能编辑。  
**Assistant**：放在你站内（pricing/terms/refund-policy），并在跳转前提示/勾选确认，避免争议时“没看到”。

